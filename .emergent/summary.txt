<analysis>
The AI engineer has progressively built out the Pizoo Dating App, starting with foundational internationalization (i18n, RTL, country codes). Key milestones included integrating Sentry for error tracking, fixing rendering issues on the Discover page, and setting up Cloudinary for image uploads. A major architectural shift involved migrating the real-time communication system from Jitsi to LiveKit, which required extensive backend (token generation) and frontend (new components) work.

More recently, the focus shifted to implementing a robust one-time account verification system (OAuth, email magic link, phone OTP with a mock service). This involved significant updates to the backend user model, authentication endpoints, and LiveKit token authorization. Concurrently, critical backend serialization errors related to MongoDB ObjectIds were resolved, ensuring JSON-safe API responses. The AI also streamlined the application's environment configuration into a structured  file and conducted a comprehensive service integration verification. The current task involves a large-scale monorepo merge.
</analysis>

<product_requirements>
The overarching goal is to enhance the Pizoo Dating App, an MVP-level application, by expanding functionality and fixing existing issues. Initial requirements included a comprehensive internationalization (i18n) system with dynamic language adaptation, RTL support, and a country code dropdown. Subsequent roadmap items covered AI Matching, an Admin Dashboard, Firebase Analytics, GDPR compliance, E2E/API testing, monitoring, performance, and documentation.

Recent explicit requests and their implementations include:
1.  **Image Upload & Language/Country Code:** Fixed NotFoundError for image uploads by enhancing Cloudinary integration and implemented comprehensive country code dropdowns.
2.  **Frontend/Backend Stability:** Resolved React Error #31 (rendering objects in JSX), fixed Failed to send message issues (CORS, backend URL, auth token), and ensured legal/support pages rendered correctly with i18n.
3.  **Real-Time Communication (RTC) Migration:** Migrated video/voice calls from Jitsi to LiveKit, involving secure token generation, SDK integration, and camera/microphone controls.
4.  **Self-Hosted LiveKit (Pending Deployment):** User requested a self-hosted LiveKit stack, for which an automated deployment package was being prepared, though the in-app integration currently uses LiveKit Cloud.
5.  **One-Time Account Verification:** Implemented a system where users are verified once at signup via OAuth, Email Magic Link, or Phone OTP. This involved adding , ,  fields to the user model, updating auth APIs, and gating LiveKit token generation on verification. A mock email service was set up for testing.
6.  **MongoDB ObjectId Serialization Fix:** Resolved  in message endpoints by ensuring all MongoDB ObjectIds are converted to strings before JSON serialization.
7.  **Environment Configuration:** Structured and normalized  configuration for all services.
8.  **Integration Verification:** Verified connectivity and permissions for GitHub, MongoDB, Hetzner, LiveKit, Cloudinary, and Sentry.
9.  **Monorepo Merge:** The current request is to refactor multiple repositories into a single monorepo with a Turborepo/Nx structure, unify package managers (pnpm), standardize configurations, and extract shared components.
</product_requirements>

<key_technical_concepts>
-   **Full-stack Architecture**: React (Frontend), FastAPI (Backend), MongoDB (Database).
-   **Internationalization (i18n)**: , RTL support.
-   **Cloudinary Integration**: Image upload, processing.
-   **Real-Time Communication (RTC)**: LiveKit (token generation, SDKs).
-   **Error Tracking**: Sentry.
-   **Authentication**: JWT, OAuth (Google), Email Magic Link, Phone OTP (Telnyx planned), password hashing.
-   **Deployment**: Docker Compose, Caddy, Coturn (for self-hosted LiveKit).
-   **Monorepo Tools**: Turborepo/Nx, pnpm.
</key_technical_concepts>

<code_architecture>
The application utilizes a React frontend and a FastAPI backend, interacting with a MongoDB database. The structure has evolved to support new features and integrations.



-   ****: Main FastAPI application.
    -   **Importance**: Central API router, integrates services, handles business logic.
    -   **Changes**: Updated User model with  fields. Added new Pydantic models (Session, TokenPair, VerificationResponse). Integrated . Added new auth endpoints (, , ,  placeholders). Modified  and  to return JSON-safe . Updated  to require user verification and rate limiting. Fixed ObjectId serialization in message-related endpoints ( and ). Fixed  import order and  retrieval logic.
-   ****: Python dependencies.
    -   **Importance**: Manages backend libraries.
    -   **Changes**: Added  and various  related packages.
-   ****: New file.
    -   **Importance**: Encapsulates authentication logic, including JWT handling, password hashing, and verification (mocked email, OAuth placeholders).
    -   **Changes**: Contains functions for , , ,  (with mock support), etc.
-   ****: LiveKit token generation.
    -   **Importance**: Securely issues LiveKit access tokens.
    -   **Changes**: Removed internal  and default  value to ensure correct environment variable loading from .
-   ****: New file.
    -   **Importance**: One-time script to initialize  for existing users in MongoDB.
-   ****: Environment variables.
    -   **Importance**: Stores critical configuration and secrets.
    -   **Changes**: Added , , , , , , , . Updated . Later replaced with a new structured  covering all integrations (GitHub, MongoDB, Hetzner, LiveKit, Cloudinary, Sentry).
-   ****: New file.
    -   **Importance**: Template for required environment variables.
-   ****: Frontend environment variables.
    -   **Importance**: Stores configuration for the frontend.
    -   **Changes**: Corrected  to  to match the deployed environment.
-   ****: Chat interface.
    -   **Importance**: Real-time messaging and call initiation.
    -   **Changes**: Updated to include verification check for displaying call buttons and conditionally rendering .
-   ****: New file.
    -   **Importance**: Direct integration of  for video/audio calls, as per user's specific code request.
    -   **Changes**: Implements fetching token from backend, connecting to LiveKit room, publishing tracks, and rendering local/remote video/audio.
-   ****: LiveKit call modal using .
    -   **Importance**: Existing component for LiveKit calls.
    -   **Changes**: Confirmed it uses the correct backend endpoint for token fetching.
</code_architecture>

<pending_tasks>
-   Build an Admin Web Dashboard (MVP with Next.js for users and stats pages).
-   Implement Firebase Analytics for key user events.
-   Enhance GDPR compliance (JWT refresh, password hashing, audit logs).
-   Implement E2E and API tests.
-   Set up comprehensive monitoring and observability (logs, healthcheck metrics, alerts).
-   Improve performance (image optimization beyond current, lazy loading, GPS fallbacks, accessibility).
-   Create detailed documentation (README, API docs, demo video) for the application itself.
-   Add recording and push notifications for incoming LiveKit calls (future phase).
-   Implement Google OAuth and Telnyx Phone OTP for account verification.
-   Deploy a self-hosted LiveKit stack with Coturn and Caddy.
</pending_tasks>

<current_work>
Immediately before this summary request, the AI engineer was engaged in two main threads of work:
1.  **LiveKit Frontend Integration:** The user provided a specific React component () and instructions to integrate it into the chat UI, making the call button visible only to verified users. The AI identified that the  in the frontend  was incorrect and updated it. A persistent issue with  being incorrectly reported by the backend's  endpoint was debugged, tracing it to  execution order and a default value in , which was subsequently fixed. After these fixes, the backend was confirmed to return the correct LiveKit Cloud URL. The AI then proceeded to create two verified test users and successfully obtained LiveKit tokens, confirming the backend and verification gates were functional for LiveKit calls. The  was updated to include the verification check for the call button. The AI then created an implementation summary document ().
2.  **Monorepo Merge (Initiation):** Following the LiveKit work, the user provided an extensive task to merge several existing GitHub repositories into a single monorepo (), using a Turborepo/Nx workspace structure. This involves standardizing default branches, migrating codebases (web frontends to , FastAPI backend to ), unifying package managers to pnpm, centralizing configurations, extracting common components, and setting up CI/CD. The AI acknowledged this complex task, noting it would proceed after addressing a critical prerequisite.
</current_work>

<optional_next_step>
The AI engineer will now begin the monorepo merge and normalization task as per the user's detailed request.
</optional_next_step>

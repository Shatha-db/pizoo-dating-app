name: Deploy to Vercel Production

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy:
    name: Trigger Vercel Deployment
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Trigger Vercel Deploy Hook
        run: |
          echo "üöÄ Triggering Vercel deployment..."
          RESPONSE=$(curl -X POST \
            "https://api.vercel.com/v1/integrations/deploy/prj_8ZKPw4z3kOreyIVPywFD4OE3EdxJ/2im8oZHyQW" \
            -H "Content-Type: application/json" \
            -s)
          
          echo "Response: $RESPONSE"
          
          JOB_ID=$(echo $RESPONSE | grep -o '"id":"[^"]*"' | head -1 | cut -d'"' -f4)
          
          if [ -n "$JOB_ID" ]; then
            echo "‚úÖ Deployment triggered successfully"
            echo "Job ID: $JOB_ID"
            echo "::notice::Vercel deployment started with Job ID: $JOB_ID"
          else
            echo "‚ùå Failed to trigger deployment"
            echo "::error::Deployment trigger failed"
            exit 1
          fi
      
      - name: Wait for deployment
        run: |
          echo "‚è≥ Waiting 90 seconds for deployment to start..."
          sleep 90
      
      - name: Verify deployment
        run: |
          echo "üîç Verifying deployment..."
          
          # Check pizoo.ch
          STATUS_1=$(curl -s -o /dev/null -w "%{http_code}" https://pizoo.ch)
          echo "pizoo.ch status: $STATUS_1"
          
          # Check www.pizoo.ch
          STATUS_2=$(curl -s -o /dev/null -w "%{http_code}" https://www.pizoo.ch)
          echo "www.pizoo.ch status: $STATUS_2"
          
          if [ "$STATUS_1" = "200" ] || [ "$STATUS_1" = "301" ]; then
            echo "‚úÖ pizoo.ch is accessible"
          else
            echo "‚ö†Ô∏è pizoo.ch returned status: $STATUS_1"
          fi
          
          if [ "$STATUS_2" = "200" ] || [ "$STATUS_2" = "301" ]; then
            echo "‚úÖ www.pizoo.ch is accessible"
          else
            echo "‚ö†Ô∏è www.pizoo.ch returned status: $STATUS_2"
          fi
          
          echo "::notice::Deployment verification completed"
